service: formuljar
frameworkVersion: '2'

plugins:
  - serverless-offline

custom:
  serverless-offline:
    host: 0.0.0.0
    httpPort: 3003

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  coreService: formuljar
  accountId: ${opt:account, '409637905256'}
  region: eu-central-1
  ui_cert: ${opt:ui_cert, "arn:aws:acm:us-east-1:409637905256:certificate/3244fc27-7cce-4a79-b134-7eca6f9a9885"}
  ui_domain: ${opt:ui_domain, "formuljar.maslick.ru"}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sqs:SendMessage
      Resource:
        Fn::GetAtt:
          - FormuljarQueue
          - Arn
  environment:
    CAPTCHA_PUBLIC: ${env:CAPTCHA_PUBLIC}
    CAPTCHA_SECRET: ${env:CAPTCHA_SECRET}
    TELEGRAM_CHAT_ID: ${env:TELEGRAM_CHAT_ID}
    TELEGRAM_BOT_TOKEN: ${env:TELEGRAM_BOT_TOKEN}
    GOOGLE_CREDENTIALS: ${env:GOOGLE_CREDENTIALS}
    HOME_URL: "https://formuljar.maslick.ru"
    QUEUE_URL: !Ref FormuljarQueue

functions:
  form:
    handler: handler.form
    memorySize: 128
    timeout: 5
    events:
      - http:
          path: /form
          method: post
          cors:
            origin: "*"

  worker:
    handler: handler.worker
    memorySize: 128
    timeout: 5
    events:
      - sqs:
          batchSize: 1
          arn:
            Fn::GetAtt:
              - FormuljarQueue
              - Arn

resources:
  - ${file(./resources/s3-cf.yml)}
  - ${file(./resources/queue.yml)}